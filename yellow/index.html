<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å‹‰å¼·ã‚¿ã‚¤ãƒãƒ¼ï¼ˆé»„è‰²ï¼‰</title>
  <style>
    /* ---------------------------
       ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆï¼ˆé»„è‰²ãƒ»ã‚ªãƒ¬ãƒ³ã‚¸å¯„ã›ï¼‰
       --------------------------- */
    :root{
      --primary: #ff9f1c;        /* æ¿ƒã„ã‚ªãƒ¬ãƒ³ã‚¸ */
      --secondary: #ffd166;      /* æ˜ã‚‹ã„é»„è‰² */
      --accent: #ffbf69;
      --bg-start: #fff7e6;
      --bg-end: #fff1cc;
      --text-dark: #2a2a2a;
      --muted: #6b6b6b;
      --white: #ffffff;
      --shadow-sm: 0 6px 18px rgba(0,0,0,0.08);
      --shadow-md: 0 18px 40px rgba(0,0,0,0.12);
    }

    /* ãƒ™ãƒ¼ã‚·ãƒƒã‚¯ãƒªã‚»ãƒƒãƒˆ */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family: -apple-system, "Hiragino Kaku Gothic ProN", "Yu Gothic", Meiryo, sans-serif;
      background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
      color:var(--text-dark);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }

    /* ã‚³ãƒ³ãƒ†ãƒŠ */
    .app {
      width:100%;
      max-width:680px;
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,250,240,0.85));
      border-radius:20px;
      padding:32px;
      box-shadow:var(--shadow-md);
      position:relative;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:18px;
    }
    .logo {
      font-weight:800;
      font-size:20px;
      background:linear-gradient(90deg,var(--primary),var(--secondary));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .controls-inline {
      display:flex;
      gap:10px;
      align-items:center;
    }
    .small-btn {
      border:none;
      background:var(--primary);
      color:white;
      padding:8px 12px;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
      box-shadow:var(--shadow-sm);
    }
    .small-btn.secondary {
      background:var(--secondary);
      color:var(--text-dark);
    }

    /* ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º */
    .timer-area {
      display:flex;
      gap:24px;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
    }
    .circle {
      width:260px;
      height:260px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      background: conic-gradient(var(--primary) 0deg, rgba(255,255,255,0.4) 0deg);
      box-shadow: var(--shadow-md);
      position:relative;
    }
    .inner {
      width:82%;
      height:82%;
      border-radius:50%;
      background:var(--white);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      box-shadow:var(--shadow-sm);
      text-align:center;
    }
    .time {
      font-size:48px;
      font-weight:800;
      letter-spacing:1px;
    }
    .mode-label {
      margin-top:8px;
      font-size:13px;
      font-weight:700;
      color:var(--muted);
    }

    /* ãƒ—ãƒªã‚»ãƒƒãƒˆ */
    .presets {
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:12px;
      margin-top:8px;
    }
    .preset {
      background:var(--white);
      border-radius:12px;
      padding:12px;
      text-align:center;
      cursor:pointer;
      box-shadow:var(--shadow-sm);
      border:2px solid transparent;
      user-select:none;
    }
    .preset.active {
      border-color:var(--primary);
      transform:translateY(-4px);
    }
    .preset .title { font-weight:800; font-size:15px }
    .preset .sub { font-size:12px; color:var(--muted) }

    /* ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ãƒãƒ« */
    .custom {
      margin-top:12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
    }
    .input {
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
    }
    .input input {
      width:100px;
      padding:10px;
      border-radius:10px;
      border:2px solid #fff;
      text-align:center;
      font-weight:700;
      font-size:18px;
      box-shadow:var(--shadow-sm);
    }

    /* å¤§ãã‚ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ */
    .main-controls {
      display:flex;
      gap:12px;
      justify-content:center;
      margin-top:18px;
      flex-wrap:wrap;
    }
    .big-btn {
      padding:14px 28px;
      border-radius:14px;
      border:none;
      font-weight:800;
      cursor:pointer;
      box-shadow:var(--shadow-sm);
      background:linear-gradient(90deg,var(--primary),var(--secondary));
      color:white;
      font-size:16px;
    }
    .big-btn.ghost {
      background:transparent;
      border:2px solid rgba(0,0,0,0.06);
      color:var(--text-dark);
    }

    /* çµ±è¨ˆ */
    .stats {
      display:flex;
      gap:12px;
      margin-top:18px;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
    }
    .stat {
      background:var(--white);
      padding:12px;
      border-radius:10px;
      box-shadow:var(--shadow-sm);
      min-width:120px;
      text-align:center;
    }
    .stat .num { font-size:20px; font-weight:800 }
    .muted { color:var(--muted) }

    /* é€šçŸ¥ */
    .notify {
      position:fixed;
      right:18px;
      top:18px;
      background:var(--white);
      border-radius:10px;
      padding:10px 14px;
      box-shadow:var(--shadow-md);
      display:none;
      font-weight:700;
    }
    .notify.show { display:block }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width:640px){
      .circle { width:200px; height:200px }
      .time { font-size:40px }
      .presets { grid-template-columns:repeat(2,1fr) }
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="å‹‰å¼·ã‚¿ã‚¤ãƒãƒ¼">
    <div class="header">
      <div class="logo">Study Timer - Yellow</div>
      <div class="controls-inline">
        <button class="small-btn secondary" id="muteBtn" aria-pressed="false">ã‚µã‚¦ãƒ³ãƒ‰</button>
        <button class="small-btn" id="clearStatsBtn">çµ±è¨ˆã‚¯ãƒªã‚¢</button>
      </div>
    </div>

    <div class="timer-area">
      <div class="circle" id="progressCircle" aria-hidden="true">
        <div class="inner" role="timer" aria-live="polite">
          <div class="time" id="timeDisplay">25:00</div>
          <div class="mode-label" id="modeLabel">é›†ä¸­ã‚¿ã‚¤ãƒ </div>
        </div>
      </div>

      <div style="min-width:220px;max-width:260px;">
        <div class="presets" id="presets">
          <div class="preset active" data-preset="pomodoro" tabindex="0"><div class="title">Pomodoro</div><div class="sub">25åˆ† / ä¼‘æ†© 5åˆ†</div></div>
          <div class="preset" data-preset="short" tabindex="0"><div class="title">çŸ­ã‚</div><div class="sub">15åˆ† / 5åˆ†</div></div>
          <div class="preset" data-preset="custom" tabindex="0"><div class="title">ã‚«ã‚¹ã‚¿ãƒ </div><div class="sub">è‡ªç”±è¨­å®š</div></div>
        </div>

        <div class="custom" id="customPanel" style="display:none;">
          <div class="input">
            <label class="muted">åˆ†</label>
            <input type="number" id="minutes" min="0" max="999" value="25" aria-label="åˆ†ã‚’è¨­å®š">
          </div>
          <div class="input">
            <label class="muted">ç§’</label>
            <input type="number" id="seconds" min="0" max="59" value="0" aria-label="ç§’ã‚’è¨­å®š">
          </div>
          <div style="display:flex;align-items:center;">
            <button class="small-btn" id="applyBtn">é©ç”¨</button>
          </div>
        </div>

        <div class="main-controls" style="margin-top:14px;">
          <button class="big-btn" id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
          <button class="big-btn ghost" id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>

        <div class="stats" style="margin-top:12px;">
          <div class="stat">
            <div class="muted">ä»Šæ—¥ã®é”æˆ</div>
            <div class="num" id="todayCount">0</div>
          </div>
          <div class="stat">
            <div class="muted">åˆè¨ˆæ™‚é–“</div>
            <div class="num" id="totalTime">0åˆ†</div>
          </div>
        </div>
      </div>
    </div>

    <div class="notify" id="notification" role="status" aria-live="polite"></div>
  </div>

  <script>
    /**
     * æ”¹è‰¯ãƒã‚¤ãƒ³ãƒˆï¼ˆè¦ç´„ï¼‰
     * - é»„è‰²/ã‚ªãƒ¬ãƒ³ã‚¸åŸºèª¿ã«ãƒ‡ã‚¶ã‚¤ãƒ³èª¿æ•´
     * - ã‚¿ã‚¤ãƒãƒ¼çµ‚äº†æ™‚ã®ã‚¢ãƒ©ãƒ¼ãƒ ï¼ˆWeb Audio APIï¼‰ã‚’è¿½åŠ ï¼ˆãƒŸãƒ¥ãƒ¼ãƒˆå¯ï¼‰
     * - èƒŒæ™¯ã®æ°´ç‰ç­‰ã®è£…é£¾ã¯é™¤å»ï¼ˆè»½é‡åŒ–ï¼‰
     * - æ™‚é–“è¨­å®šä¸å…·åˆã‚’ä¿®æ­£ï¼ˆpreset.duration / preset.break ã‚’æ­£ã—ãå‚ç…§ï¼‰
     * - æ©Ÿèƒ½å„ªå…ˆã§ã‚³ãƒ¼ãƒ‰ã‚’æ•´ç†ï¼ˆå¯èª­æ€§ãƒ»ä¿å®ˆæ€§å‘ä¸Šï¼‰
     */

    (function(){
      'use strict';

      /* -----------------------------
         å®šæ•°ãƒ»è¨­å®šï¼ˆç·¨é›†ã—ã‚„ã™ã„ï¼‰
         ----------------------------- */
      const PRESETS = {
        pomodoro: { duration: 25 * 60, break: 5 * 60, label: 'Pomodoro' },
        short:   { duration: 15 * 60, break: 5 * 60, label: 'çŸ­ã‚' },
        custom:  { duration: 25 * 60, break: 5 * 60, label: 'ã‚«ã‚¹ã‚¿ãƒ ' }
      };

      const MOTIVATIONS = [
        'ç´ æ™´ã‚‰ã—ã„ã‚¹ã‚¿ãƒ¼ãƒˆã§ã™',
        'é›†ä¸­åŠ›ãŒé«˜ã¾ã£ã¦ã„ã¾ã™',
        'é †èª¿ã«é€²ã‚“ã§ã„ã¾ã™ã­',
        'ãã®èª¿å­ã§é ‘å¼µã‚Šã¾ã—ã‚‡ã†',
        'ã‚ã¨å°‘ã—ã§é”æˆã§ã™'
      ];

      const COMPLETION_MSGS = [
        'ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼',
        'ä¼‘æ†©ã‚’å–ã‚Šã¾ã—ã‚‡ã†',
        'ã‚ˆãã‚„ã‚Šã¾ã—ãŸï¼'
      ];

      /* -----------------------------
         çŠ¶æ…‹ï¼ˆstateï¼‰
         - timeLeft ã¯å¸¸ã«ç§’ã§ä¿æŒ
         - totalTime ã¯ç¾åœ¨ãƒ¢ãƒ¼ãƒ‰ã§ã®åˆè¨ˆç§’
         ----------------------------- */
      let state = {
        presetKey: 'pomodoro', // ç¾åœ¨é¸æŠãƒ—ãƒªã‚»ãƒƒãƒˆã®ã‚­ãƒ¼
        mode: 'work',          // 'work' or 'break'
        timeLeft: PRESETS.pomodoro.duration,
        totalTime: PRESETS.pomodoro.duration,
        running: false,
        intervalId: null,
        custom: { duration: PRESETS.custom.duration, break: PRESETS.custom.break },
        soundEnabled: true
      };

      /* -----------------------------
         DOMå‚ç…§ï¼ˆã¾ã¨ã‚ã¦ç®¡ç†ï¼‰
         ----------------------------- */
      const D = {
        presets: document.getElementById('presets'),
        presetCards: document.querySelectorAll('.preset'),
        customPanel: document.getElementById('customPanel'),
        minutes: document.getElementById('minutes'),
        seconds: document.getElementById('seconds'),
        applyBtn: document.getElementById('applyBtn'),
        startBtn: document.getElementById('startBtn'),
        resetBtn: document.getElementById('resetBtn'),
        timeDisplay: document.getElementById('timeDisplay'),
        modeLabel: document.getElementById('modeLabel'),
        progressCircle: document.getElementById('progressCircle'),
        todayCount: document.getElementById('todayCount'),
        totalTimeEl: document.getElementById('totalTime'),
        notification: document.getElementById('notification'),
        muteBtn: document.getElementById('muteBtn'),
        clearStatsBtn: document.getElementById('clearStatsBtn')
      };

      /* -----------------------------
         ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼
         ----------------------------- */
      const STORAGE_KEYS = {
        STATE: 'ft_state_v1',
        STATS: 'ft_stats_v1'
      };

      /* -----------------------------
         ã‚µã‚¦ãƒ³ãƒ‰ï¼ˆWeb Audio APIï¼‰ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
         - ã‚¢ãƒ©ãƒ¼ãƒ ã‚’5ç§’ã¾ãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼åœæ­¢ã¾ã§é³´ã‚‰ã™
         - ãƒŸãƒ¥ãƒ¼ãƒˆæ©Ÿèƒ½ã«å¯¾å¿œ
         ----------------------------- */
      const Sound = (function(){
        let ctx = null;
        let masterGain = null;
        let alarmOscs = [];
        let alarmTimeout = null;

        function ensureCtx(){
          if (!ctx) {
            try {
              ctx = new (window.AudioContext || window.webkitAudioContext)();
              masterGain = ctx.createGain();
              masterGain.gain.value = 0.8;
              masterGain.connect(ctx.destination);
            } catch (e) {
              console.warn('AudioContext unavailable', e);
              ctx = null;
            }
          }
        }

        function startAlarm(durationSec = 5){
          if (!state.soundEnabled) return;
          ensureCtx();
          if (!ctx) return;
          stopAlarm(); // æ—¢å­˜åœæ­¢

          // ã‚·ãƒ³ãƒ—ãƒ«ãªçŸ­ã„ãƒ“ãƒ¼ãƒ—ã®çµ„ã¿åˆã‚ã›ã‚’ãƒ«ãƒ¼ãƒ—
          const freqs = [880, 660, 990];
          freqs.forEach((f, i) => {
            const osc = ctx.createOscillator();
            const g = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.value = f;
            g.gain.value = 0;
            osc.connect(g);
            g.connect(masterGain);
            const now = ctx.currentTime + i * 0.08;
            g.gain.linearRampToValueAtTime(0.5, now + 0.01);
            g.gain.exponentialRampToValueAtTime(0.01, now + 0.35);
            osc.start(now);
            osc.stop(now + 0.4);
            alarmOscs.push(osc);
          });

          // å°ä¼‘æ­¢ã‚’ç½®ã„ã¦ç¹°ã‚Šè¿”ã™ï¼ˆdurationSecã¾ã§ï¼‰
          const repeatInterval = 600; // ms
          let elapsed = 0;
          function loop(){
            if (!ctx) return;
            if (elapsed >= durationSec * 1000) {
              stopAlarm();
              return;
            }
            elapsed += repeatInterval;
            // æ¬¡ã®é³´å‹•ã‚’ã‚»ãƒƒãƒˆï¼ˆç°¡æ½”ã«ï¼‰
            alarmTimeout = setTimeout(loop, repeatInterval);
            // åˆ¥éŸ³è‰²ã‚’ã»ã‚“ã®å°‘ã—é³´ã‚‰ã™
            const osc = ctx.createOscillator();
            const g = ctx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.value = 520;
            g.gain.value = 0;
            osc.connect(g); g.connect(masterGain);
            const now = ctx.currentTime;
            g.gain.linearRampToValueAtTime(0.4, now + 0.01);
            g.gain.exponentialRampToValueAtTime(0.01, now + 0.25);
            osc.start(now);
            osc.stop(now + 0.25);
            alarmOscs.push(osc);
          }
          alarmTimeout = setTimeout(loop, 450);
        }

        function stopAlarm(){
          if (alarmTimeout) { clearTimeout(alarmTimeout); alarmTimeout = null; }
          if (alarmOscs.length && ctx) {
            try {
              alarmOscs.forEach(o => {
                try { o.disconnect(); } catch(_) {}
              });
            } catch(e){}
            alarmOscs = [];
          }
        }

        return { startAlarm, stopAlarm };
      })();

      /* -----------------------------
         ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
         ----------------------------- */
      function secondsToText(s){
        const m = Math.floor(s / 60);
        const sec = s % 60;
        return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
      }

      function showNotification(message, timeout = 3000){
        D.notification.textContent = message;
        D.notification.classList.add('show');
        setTimeout(()=> D.notification.classList.remove('show'), timeout);
      }

      /* -----------------------------
         ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ“ä½œï¼ˆçŠ¶æ…‹ãƒ»çµ±è¨ˆï¼‰
         ----------------------------- */
      function saveState(){
        try {
          const toSave = {
            presetKey: state.presetKey,
            custom: state.custom,
            soundEnabled: state.soundEnabled
          };
          localStorage.setItem(STORAGE_KEYS.STATE, JSON.stringify(toSave));
        } catch(e){ console.warn('saveState err', e) }
      }

      function loadState(){
        try {
          const raw = localStorage.getItem(STORAGE_KEYS.STATE);
          if (!raw) return;
          const parsed = JSON.parse(raw);
          if (parsed.presetKey) state.presetKey = parsed.presetKey;
          if (parsed.custom) {
            state.custom = parsed.custom;
            PRESETS.custom.duration = parsed.custom.duration;
            PRESETS.custom.break = parsed.custom.break;
          }
          if (typeof parsed.soundEnabled === 'boolean') state.soundEnabled = parsed.soundEnabled;
        } catch(e){ console.warn('loadState err', e) }
      }

      function loadStats(){
        try {
          const raw = localStorage.getItem(STORAGE_KEYS.STATS);
          if (!raw) return { };
          return JSON.parse(raw);
        } catch(e){ return {}; }
      }

      function saveStats(stats){
        try {
          localStorage.setItem(STORAGE_KEYS.STATS, JSON.stringify(stats));
        } catch(e){ console.warn('saveStats err', e) }
      }

      function updateStatsOnComplete(){
        try {
          const stats = loadStats();
          const key = new Date().toDateString();
          if (!stats[key]) stats[key] = { count:0, time:0 };
          stats[key].count += 1;
          stats[key].time += state.totalTime;
          saveStats(stats);
          refreshStatsDisplay();
        } catch(e){ console.warn('updateStatsOnComplete err', e) }
      }

      function refreshStatsDisplay(){
        try {
          const stats = loadStats();
          const key = new Date().toDateString();
          const today = stats[key] || { count:0, time:0 };
          D.todayCount.textContent = today.count;
          D.totalTimeEl.textContent = Math.floor((today.time || 0) / 60) + 'åˆ†';
        } catch(e){ console.warn(e) }
      }

      /* -----------------------------
         ãƒ—ãƒªã‚»ãƒƒãƒˆ / ã‚«ã‚¹ã‚¿ãƒ  é¸æŠ
         ----------------------------- */
      function setActivePreset(key){
        state.presetKey = key;
        // UIåˆ‡æ›¿
        D.presetCards.forEach(c => c.classList.toggle('active', c.dataset.preset === key));
        if (key === 'custom') {
          D.customPanel.style.display = 'flex';
          // ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ã«ç¾åœ¨å€¤ã‚’åæ˜ ã—ã¦ãŠã
          const mins = Math.floor(state.custom.duration / 60);
          const secs = state.custom.duration % 60;
          D.minutes.value = mins;
          D.seconds.value = secs;
        } else {
          D.customPanel.style.display = 'none';
        }
        // ç¾åœ¨ãƒ¢ãƒ¼ãƒ‰ã®æ™‚é–“ã‚’ãƒªã‚»ãƒƒãƒˆ
        applyPresetTimesToState();
        saveState();
        renderDisplay();
      }

      function applyPresetTimesToState(){
        const preset = PRESETS[state.presetKey];
        if (!preset) return;
        state.totalTime = (state.mode === 'work') ? preset.duration : preset.break;
        state.timeLeft = state.totalTime;
      }

      /* -----------------------------
         ã‚«ã‚¹ã‚¿ãƒ é©ç”¨ï¼ˆå…¥åŠ›æ¤œè¨¼å«ã‚€ï¼‰
         ----------------------------- */
      function applyCustom(){
        const mins = Math.max(0, parseInt(D.minutes.value || '0', 10));
        let secs = Math.max(0, parseInt(D.seconds.value || '0', 10));
        if (isNaN(mins) || isNaN(secs)) {
          showNotification('ç„¡åŠ¹ãªå€¤ã§ã™', 2500);
          return;
        }
        if (secs > 59) secs = 59; // ä¸Šé™è£œæ­£
        const total = mins * 60 + secs;
        if (total <= 0) {
          showNotification('0ã‚ˆã‚Šå¤§ãã„æ™‚é–“ã‚’è¨­å®šã—ã¦ãã ã•ã„', 2500);
          return;
        }

        state.custom.duration = total;
        // breakã¯å›ºå®š5åˆ†ï¼ˆå¿…è¦ãªã‚‰UIã«å…¥ã‚Œã‚‹ï¼‰
        state.custom.break = 5 * 60;
        PRESETS.custom.duration = total;
        PRESETS.custom.break = state.custom.break;

        // ã‚«ã‚¹ã‚¿ãƒ ãŒé¸æŠä¸­ãªã‚‰å³é©ç”¨
        if (state.presetKey === 'custom') {
          applyPresetTimesToState();
        }
        saveState();
        showNotification('ã‚«ã‚¹ã‚¿ãƒ ã‚’é©ç”¨ã—ã¾ã—ãŸ');
        renderDisplay();
      }

      /* -----------------------------
         ã‚¿ã‚¤ãƒãƒ¼åˆ¶å¾¡ï¼ˆstart/pause/reset/completeï¼‰
         ----------------------------- */
      function startPause(){
        if (state.running) {
          pauseTimer();
        } else {
          startTimer();
        }
      }

      function startTimer(){
        if (state.running) return;
        state.running = true;
        D.startBtn.textContent = 'ä¸€æ™‚åœæ­¢';
        // tick every second
        state.intervalId = setInterval(() => {
          state.timeLeft = Math.max(0, state.timeLeft - 1);
          renderDisplay();
          if (state.timeLeft <= 0) {
            handleCompletion();
          }
        }, 1000);
      }

      function pauseTimer(){
        state.running = false;
        D.startBtn.textContent = 'ã‚¹ã‚¿ãƒ¼ãƒˆ';
        if (state.intervalId) {
          clearInterval(state.intervalId);
          state.intervalId = null;
        }
      }

      function resetTimer(){
        pauseTimer();
        applyPresetTimesToState();
        renderDisplay();
      }

      function handleCompletion(){
        pauseTimer();

        // åŠ¹æœéŸ³ãƒ»ã‚¢ãƒ©ãƒ¼ãƒ 
        if (state.soundEnabled) {
          Sound.startAlarm(6); // æœ€å¤§6ç§’é³´ã‚‹ï¼ˆè‡ªå‹•åœæ­¢ï¼‰
        }

        // çµ±è¨ˆã¯workå®Œäº†æ™‚ã«æ›´æ–°
        if (state.mode === 'work') {
          updateStatsOnComplete();
        }

        // é€šçŸ¥
        const msg = (state.mode === 'work') ? COMPLETION_MSGS[Math.floor(Math.random()*COMPLETION_MSGS.length)] : 'ä¼‘æ†©ãŒçµ‚ã‚ã‚Šã¾ã—ãŸ';
        showNotification(msg, 4000);

        // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼ˆwork -> break, break -> workï¼‰
        state.mode = (state.mode === 'work') ? 'break' : 'work';
        // æ¬¡ãƒ¢ãƒ¼ãƒ‰ã®æ™‚é–“ã‚’ã‚»ãƒƒãƒˆ
        applyPresetTimesToState();
        renderDisplay();
      }

      /* -----------------------------
         æç”» / UIæ›´æ–°
         - ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ï¼ˆå††ï¼‰ã‚’ã‚ã‹ã‚Šã‚„ã™ãæç”»
         - ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã¯çµŒéç‡ã§åˆ‡æ›¿
         ----------------------------- */
      function renderDisplay(){
        // æ™‚åˆ»è¡¨ç¤º
        D.timeDisplay.textContent = secondsToText(state.timeLeft);
        D.modeLabel.textContent = (state.mode === 'work') ? 'é›†ä¸­ã‚¿ã‚¤ãƒ ' : 'ä¼‘æ†©ã‚¿ã‚¤ãƒ ';

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹: çµŒéç‡ï¼ˆ0..1ï¼‰
        const elapsed = (state.totalTime - state.timeLeft) / Math.max(1, state.totalTime);
        const angle = Math.round(elapsed * 360);
        D.progressCircle.style.background = `conic-gradient(var(--primary) ${angle}deg, rgba(255,255,255,0.5) ${angle}deg)`;

        // Start/Stop ãƒœã‚¿ãƒ³è¡¨ç¤º
        D.startBtn.textContent = state.running ? 'ä¸€æ™‚åœæ­¢' : 'ã‚¹ã‚¿ãƒ¼ãƒˆ';

        // ãƒ¢ãƒãƒ™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆç°¡æ˜“ï¼‰
        // ï¼ˆè¡¨ç¤ºã¯é€šçŸ¥ã«ã—ã¦ã„ã‚‹ãŸã‚ä¸è¦ãªã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆå¯ï¼‰
        // updateMotivation(elapsed);
      }

      /* -----------------------------
         ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒãƒ³ãƒ‰ãƒ©
         ----------------------------- */
      function handleKey(e){
        // å…¥åŠ›ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã¯ç„¡è¦–
        if (document.activeElement && document.activeElement.tagName === 'INPUT') return;

        if (e.key === ' '){
          e.preventDefault();
          startPause();
        } else if (e.key.toLowerCase() === 'r'){
          resetTimer();
        } else if (e.key === '1') {
          setActivePreset('pomodoro');
        } else if (e.key === '2') {
          setActivePreset('short');
        } else if (e.key === '3') {
          setActivePreset('custom');
        }
      }

      /* -----------------------------
         åˆæœŸåŒ–å‡¦ç†ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ãªã©ï¼‰
         ----------------------------- */
      function bindEvents(){
        // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚¯ãƒªãƒƒã‚¯ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
        D.presetCards.forEach(card => {
          card.addEventListener('click', ()=> setActivePreset(card.dataset.preset));
          card.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              setActivePreset(card.dataset.preset);
            }
          });
        });

        D.applyBtn.addEventListener('click', applyCustom);
        D.startBtn.addEventListener('click', startPause);
        D.resetBtn.addEventListener('click', resetTimer);

        D.muteBtn.addEventListener('click', () => {
          state.soundEnabled = !state.soundEnabled;
          D.muteBtn.textContent = state.soundEnabled ? 'ğŸ”” ã‚µã‚¦ãƒ³ãƒ‰' : 'ğŸ”• ç„¡éŸ³';
          D.muteBtn.setAttribute('aria-pressed', String(!state.soundEnabled));
          saveState();
          if (!state.soundEnabled) Sound.stopAlarm();
        });

        D.clearStatsBtn.addEventListener('click', () => {
          if (!confirm('çµ±è¨ˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) return;
          localStorage.removeItem(STORAGE_KEYS.STATS);
          refreshStatsDisplay();
          showNotification('çµ±è¨ˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        });

        document.addEventListener('keydown', handleKey);

        // ã‚¨ãƒ³ã‚¿ãƒ¼ã§ã‚«ã‚¹ã‚¿ãƒ é©ç”¨
        D.minutes.addEventListener('keydown', (e) => { if (e.key === 'Enter') applyCustom(); });
        D.seconds.addEventListener('keydown', (e) => { if (e.key === 'Enter') applyCustom(); });
      }

      /* -----------------------------
         èµ·å‹•æ™‚å‡¦ç†
         ----------------------------- */
      function init(){
        loadState();
        refreshStatsDisplay();
        // é¸æŠãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å¾©å…ƒã—ã€stateã«æ™‚é–“ã‚’ã‚»ãƒƒãƒˆ
        setActivePreset(state.presetKey);
        bindEvents();
        renderDisplay();
      }

      // åˆæœŸåŒ–
      init();

      // ç”»é¢ã‚’é›¢ã‚Œã‚‹æ™‚ã¯ã‚¿ã‚¤ãƒãƒ¼ã‚’æ­¢ã‚ã‚‹ & ã‚µã‚¦ãƒ³ãƒ‰åœæ­¢
      window.addEventListener('beforeunload', () => {
        pauseTimer();
        Sound.stopAlarm();
      });

    })();
  </script>
</body>
</html>
